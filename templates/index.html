<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Sentiment Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
    <style>
        /* Add some initial styles for the toggle container to be hidden */
        #toggleContainer {
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Stock Market Sentiment Analyzer</h1>
        </header>
        
        <form id="stockForm" class="form-container">
            <input type="text" name="ticker" id="ticker" placeholder="Enter stock ticker" required>
            <button type="submit">Analyze</button>
        </form>

        <div class="content-container">
            <div class="left-quadrant">
                <div id="resultData" class="result"></div> <!-- Table for parameters -->
                <div class="toggle" id="toggleResult" style="display: none;">Show JSON Results</div> <!-- Initially hidden -->
                <div id="toggleContainer">
                    <pre id="jsonData" style="display: none;"></pre> <!-- JSON/cleaned up data initially hidden -->
                </div>
            </div>
            
            <div class="right-quadrant">
                <h2>Analysis Placeholder</h2>
                <p>This section will contain the actual analysis.</p>
                <div class="chart-container">
                    <canvas id="stockChart"></canvas> <!-- Chart.js Canvas -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('stockForm');
        const tickerInput = document.getElementById('ticker');
        const ctx = document.getElementById('stockChart').getContext('2d');
        let stockChart;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const ticker = tickerInput.value;

            // Fetch data from the backend
            fetch('/analyze_stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
                // If a chart exists, destroy it before creating a new one
                if (stockChart) {
                    stockChart.destroy();
                }

                // Convert the JSON object to a pretty string
                const jsonData = JSON.stringify(data, null, 2); // Pretty-print with 2 spaces indentation
                
                // Define the parameters you want to display
                const parameters = [
                    { name: "Ticker", value: data.ticker },
                    { name: "Current Price", value: `$${data.current_price.toFixed(2)}` },
                    { name: "Open Price", value: `$${data.open_price.toFixed(2)}` },
                    { name: "High Price", value: `$${data.high_price.toFixed(2)}` },
                    { name: "Low Price", value: `$${data.low_price.toFixed(2)}` },
                    { name: "Volume", value: data.volume.toLocaleString() },
                    { name: "Market Cap", value: `$${data.market_cap.toLocaleString()}` },
                    { name: "P/E Ratio", value: data.pe_ratio.toFixed(2) },
                    { name: "EPS", value: `$${data.eps.toFixed(2)}` },
                    { name: "Dividend Yield", value: `${data.dividend_yield.toFixed(2)}%` },
                    { name: "Year High", value: `$${data.year_high.toFixed(2)}` },
                    { name: "Year Low", value: `$${data.year_low.toFixed(2)}` },
                ];

                // Generate table rows dynamically
                const rows = parameters.map(param => `
                    <tr>
                        <td>${param.name}</td>
                        <td>${param.value}</td>
                    </tr>
                `).join('');

                // Display results, Makes a table
                document.getElementById('resultData').innerHTML = `
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
                `;

                // Display the JSON data in the toggle container but keep it hidden initially
                document.getElementById('jsonData').textContent = jsonData;

                // Show results container and make it visible
                const toggleContainer = document.getElementById('toggleContainer');
                toggleContainer.style.display = 'block'; // Show the results container
                const resultData = document.getElementById('resultData');
                resultData.style.display = 'block'; // Ensure results are shown
                
                // Show the toggle button after analyzing
                const toggleResult = document.getElementById('toggleResult');
                toggleResult.style.display = 'block'; // Show toggle button
            })
            .catch(error => console.error('Error fetching stock data:', error));
        });

        // Toggle JSON visibility
        const toggleResult = document.getElementById('toggleResult');
        toggleResult.addEventListener('click', function () {
            const toggleContainer = document.getElementById('toggleContainer');
            const jsonData = document.getElementById('jsonData');
            const isOpen = jsonData.style.display === 'block';
            jsonData.style.display = isOpen ? 'none' : 'block'; // Toggle visibility of JSON
            toggleContainer.style.display = isOpen ? 'none' : 'block'; // Show/hide toggle container based on JSON visibility
            toggleResult.classList.toggle('open', !isOpen); // Add or remove 'open' class
            toggleResult.textContent = isOpen ? 'Show JSON Results' : 'Hide JSON Results'; // Update text
        });
    </script>
</body>
</html>
